Single-molecule Dataset (SMD) Format
==

Installation
--

1.  Download this repository from  
    https://github.com/smdata/smd-matlab/archive/master.zip  

2.  Unzip `master.zip` to some location (e.g. `c:\path\`)

3.  Add the `smdata` directory to the Matlab path by typing

    ```
    addpath(genpath('c:\path\smd-matlab\'))
    ```

    where `c:\path\` is the directory where `master.zip` was unpacked.


Format Layout
--

The representation of an SMD structure in Matlab is as follows

> -   **dataset** : `struct`  
    -   **.id** : `string`  
        Unique identifier for collection of traces (e.g. a hash)
    -   **.type** : `string`  
        Decriptor for datatype
    -   **.columns** : `1 x D cell`  
        column labels, e.g. `{'donor', 'acceptor'}`, `{'fret'}`, 
        `{'viterbi_state_mean', 'viterbi_state_index'}`
    -   **.attr** : `struct`  
        Dataset level features (e.g. descriptors of experimental 
        conditions)
    -   **.data** : `1 x N struct`  
        -   **.id** : `string`  
            Unique identifier for trace (e.g. a hash)
        -   **.attr** : `struct`  
            Any trace-specific features that are not series
        -   **.index** : `T x 1 matrix`  
            Row index for trace data (e.g. acquisition times)
        -   **.values** : `T x D matrix`  
            Trace data. `dataset.data(n).values(t, d)` contains the value of
            trace `n`, column `d`, at index `t`.  

The top-level structure of the SMD format contains four fields 

-   **id**: This field serves as a unique identifier for the particular set of traces that are grouped in this data structure. While there are no specific requirements enforced by SMD, it is recommended that a hash function be used to generate a identifier for each data set.  This will help insure that when data sets generated at different times are combined it will be easy to track the source of each data set.
-   **attr**: This attributes field is provided to store information related to that particular group of traces. This could be information such as the day the experiment was completed, the exact experimental conditions, or any other information that relates to the data set as a whole.
-   **columns**: This holds a set of labels that describe the columns in each values entry for individual time series, which are assumed to be identical across the data set (e.g. donor, acceptor, Viterbi algorithm-inferred state). 
-   **data**: This holds a list of entries for each trace, which themselves contain a set of fields:
    -   **id**: This field holds a trace-specific identifier, which may be generated by running a hash function on the values matrix.
    -   **index**: This field contains a list of row labels for the values matrix, which typically hold the measurement times. This field should have the same length as the values field. 
    -   **values**: This field contains the actual trace data, where each column represents a different channel. Most simply, a channel can contain raw single molecule data, but depending on the user, it could equally well be used to store window-averaged data, thresholded data, fits of the data or an arbitrary number of other series data.
    -   **attr**: This attributes field has much the same role as the top-level attribute field, but is specific to this particular trace. Within this data field a user can store any additional information they are interested in storing. This could be anything from a kinetic or thermodynamic parameter algorithmically determined for a particular trace to an observation of that particular trace that an experimentalist wants to note for future reference.

Functions
--

**smd.create(data, column_labels, varargin)**: Creates a SMD structure from supplied data.

**smd.write_json(filename, dataset)**: Saves a SMD structure as JSON (`.json`)or compressed JSON (`.json.gz`).

**smd.read_json(filename)**: Loads a SMD structure from JSON (`.json`)or compressed JSON (`.json.gz`).

**smd.isvalid(dataset)**: Checks if supplied struct is a valid SMD instance.

**smd.filter(dataset)**: Returns a filtered dataset by matching `id` and `attr` values, or by applying a custom function with boolean output to each trace.

**smd.merge(data1, data2, ...)**: Returns a merged dataset containing all traces in multiple datasets.

Example Usage
--

Generate some fake data: Mixture of 3 gaussian distributions

```matlab
state_mean = [0.1, 0.5, 0.7];
state_noise = [0.05, 0.10, 0.05];
num_traces = 10;
max_length = 100;
for n = 1:num_traces
    T = ceil(max_length * rand());
    states = ceil(length(state_mean) * rand(T,1));
    observations = state_mean(states)' + state_noise(states)' .* randn(T,1);
    data{n} = [states, observations];
end
```

Create a SMD structure

```matlab
% initialize smd dataset
dataset = smd.create(data, {'state', 'observation'})
% add global attributes 
dataset.attr.description = 'example data: mixture of 3 gaussians with equal occupancy';
dataset.attr.state_mean = state_mean;
dataset.attr.state_noise = state_noise;
dataset.attr.max_length = max_length;
```

Save data to disk

```matlab
% save as Matlab data
save('example.mat', 'dataset', '-struct');
% save as plain text JSON (uncompressed)
smd.write_json('example.json', dataset);
% save as plain text JSON (with gzip compression)
smd.write_json('example.json.gz', dataset);
```

Load data from disk
```matlab
% read matlab data
example = load('example.mat');
% read plain text json (uncompressed)
example = smd.read_json('example.json', dataset);
% read plain text json (with gzip compression)
example = smd.read_json('example.json.gz', dataset);
```

Filter data
```matlab
% filter out traces with <= 50 data points
filtered = smd.filter(example, 'func', @(d) size(d.values,1) > 50);
```